{% extends "_base.html" %}
{% block title %}Email Analysis{% endblock title %}

{% block extra_head %}
<script src="https://cdn.tiny.cloud/1/92mosh0pocxlyqaqq283z7fo78ooaah63cmezpmdlkzoiama/tinymce/7/tinymce.min.js" referrerpolicy="origin" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@tinymce/tinymce-webcomponent/dist/tinymce-webcomponent.min.js"></script>
{% endblock extra_head %}

{% block content %}
<div class="container mt-4">
    <form id="emailForm">
        <div class="form-floating mb-3">
            <textarea class="form-control" placeholder="Enter Email Content" id="emailContent" name="email_content" style="height: 200px;" required></textarea>
            <label for="emailContent">Email Content</label>
        </div>
        <input type="hidden" id="originalHtmlInput" name="originalHtml">
        <button type="submit" id="submitBtn" class="btn btn-primary">Analyze</button>
    </form>

    <div id="resultSection" class="mt-4" style="display: none;">
        <h4>Results:</h4>
        <div id="parsedResults"></div>
    </div>

    <!-- Editor Container -->
    <div class="mt-4 d-none" id="editorContainer">
        <label for="emailEditor" class="form-label">Rewritten Email (Editable)</label>
        <textarea id="emailEditor" class="form-control" rows="10"></textarea>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="updatePreview()">Preview Changes</button>
        <button class="btn btn-sm btn-outline-warning mt-2 ms-2" onclick="regenerateEmail()">Regenerate</button>
    </div>

    <!-- Live Preview -->
    <div class="mt-4 d-none" id="livePreviewContainer">
        <label class="form-label">Live Preview</label>
        <iframe id="emailPreview" class="w-100 border" style="height: 400px;"></iframe>
    </div>

    <div id="resultsErrorOutput" style="display: none;"></div>

</div>


<script>

    document.addEventListener("DOMContentLoaded", function () {
    tinymce.init({
        selector: '#emailEditor',
        plugins: [
        // Core features
        'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'image', 'link', 'lists',
        'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
        ],

        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',

        tinycomments_mode: 'embedded',
        tinycomments_author: 'Sourabh',
    });
    });


    async function regenerateEmail() {
        //const currentHTML = tinymce.get('emailEditor').getContent();
        const currentHTML = document.getElementById("originalHtmlInput").value;
        const improvementsCard = document.getElementById("improvementsCard");
        const originalHtmlInput = document.getElementById("originalHtmlInput");
        try {
            showLoader();
            const response = await fetch('/regenerate-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ html_content: currentHTML })
            });

            const data = await response.json();

            if (response.ok) {
                // Update editor content

                tinymce.get('emailEditor').setContent(data.rewritten_email);
                updatePreview();
                improvementsCard.innerHTML = `
                <div class="card-header bg-primary text-white">Key Improvements</div>
                        <div class="card-body">
                            ${
                                data.improvements.length > 0
                                    ? data.improvements.map(imp => `
                                        <div class="mb-3">
                                            <h6 class="fw-bold mb-1">${imp.title}</h6>
                                            <p class="mb-0 text-muted">${imp.reason}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-muted mb-0"><em>No improvements returned.</em></p>'
                            }
                        </div>
                `
                originalHtmlInput.value = data.rewritten_email || "";
                hideLoader();
            } else {
                alert("Regeneration failed: " + (data.error || "Unknown error"));
                hideLoader();
            }
        } catch (error) {
            alert("Network error: " + error.message);
            hideLoader();
        }
    }



    function updatePreview() {
            const html = tinymce.get('emailEditor').getContent();
            document.getElementById('emailPreview').srcdoc = html;
    }
    
    function parseQualityOutput(text) {
        const spamScoreMatch = text.match(/Spam Score:\s*(\d+)/);
        const spammyMatch = text.match(/Spammy Phrases:\s*(.+)/);
        const goodMatch = text.match(/Good Phrases:\s*(.+)/);
        const commentsMatch = text.match(/Comments:\s*(.+)/s);
        const livePreviewContainer = document.getElementById("livePreviewContainer");
        const editorContainer = document.getElementById("editorContainer");
        
        return {
            spam_score: spamScoreMatch ? spamScoreMatch[1] : "N/A",
            spammy: spammyMatch ? spammyMatch[1].split(',').map(x => x.trim()) : [],
            good: goodMatch && goodMatch[1].toLowerCase() !== "none" ? goodMatch[1].split(',').map(x => x.trim()) : [],
            comments: commentsMatch ? commentsMatch[1].trim() : "No comments"
        };
    }
    
    
    const form = document.getElementById("emailForm");
    const textarea = document.getElementById("emailContent");
    const button = document.getElementById("submitBtn");
    const resultSection = document.getElementById("resultSection");
    const resultsErrorOutput = document.getElementById("resultsErrorOutput");
    const originalHtmlInput = document.getElementById("originalHtmlInput");

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        showLoader();
        // Disable input and button
        textarea.disabled = true;
        button.disabled = true;
        button.textContent = "Analyzing...";
        
        try {
            const response = await fetch("/analyze-email", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    email_content: textarea.value
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Parse the 'quality_check' response manually
                //const parsedQuality = parseQualityOutput(data.quality_check);
                const parsedQuality = JSON.parse(data.quality_check);

                // Extract the structured rewritten response
                const rewritten_data = JSON.parse(data.rewritten_email)
                const rewritten = rewritten_data.rewritten_email;
                const improvements = rewritten_data.key_improvements || [];
                originalHtmlInput.value = rewritten || "";

                console.log(parsedQuality)
                console.log(rewritten_data)
                // Build HTML dynamically
                parsedResults.innerHTML = `
                    <div class="mb-3">
                        <h5 class="text-primary">Spam Score: <span class="badge bg-danger">${parsedQuality.spam_score}</span></h5>
                    </div>

                    <div class="mb-3">
                        <strong>Spammy Phrases:</strong><br>
                        ${parsedQuality.spammy_phrases.map(word => `<span class="badge bg-warning text-dark me-1 mb-1">${word}</span>`).join(' ') || '<em>None</em>'}
                    </div>

                    <div class="mb-3">
                        <strong>Good Phrases:</strong><br>
                        ${parsedQuality.good_phrases.map(word => `<span class="badge bg-success me-1 mb-1">${word}</span>`).join(' ') || '<em>None</em>'}
                    </div>

                    <div class="alert alert-info" role="alert">
                        <strong>Comments:</strong><br> ${parsedQuality.comments}
                    </div>

                    <div class="card mb-4 d-none">
                        <div class="card-header bg-success text-white">Rewritten Email</div>
                        <div class="card-body" >
                            <pre class="mb-0" style="white-space: pre-wrap;" id="rewrittenEmailContent">${rewritten}</pre>
                        </div>
                    </div>

                    <div class="card" id="improvementsCard">
                        <div class="card-header bg-primary text-white">Key Improvements</div>
                        <div class="card-body">
                            ${
                                improvements.length > 0
                                    ? improvements.map(imp => `
                                        <div class="mb-3">
                                            <h6 class="fw-bold mb-1">${imp.title}</h6>
                                            <p class="mb-0 text-muted">${imp.reason}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-muted mb-0"><em>No improvements returned.</em></p>'
                            }
                        </div>
                    </div>
                `;

                resultSection.style.display = "block";
                
                // Populate TinyMCE editor after receiving response
                //console.log('updating tinymce editor with:', rewritten);
                tinymce.get('emailEditor').setContent(rewritten);
                updatePreview(); // Optional: show preview immediately
                editorContainer.classList.remove("d-none");
                livePreviewContainer.classList.remove("d-none");
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }
            else {
                resultsErrorOutput.textContent = "Error: " + (data.error || "Something went wrong");
                resultsErrorOutput.style.display = "block";
            }
        } catch (error) {
            resultsErrorOutput.textContent = "Network error: " + error.message;
            resultsErrorOutput.style.display = "block";
        }

        // Re-enable input and button
        textarea.disabled = false;
        button.disabled = false;
        button.textContent = "Analyze";
        hideLoader();
        resultSection.focus()
    });
</script>


{% endblock content %}
